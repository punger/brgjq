<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>BBGG 1</title>
    <link rel="stylesheet/less" type="text/css" href="less/style.less" />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.5.0/less.min.js" type="text/javascript"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link type="text/css" rel="stylesheet" href="w2ui/w2ui-1.3.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script type="text/javascript" src="w2ui/w2ui-1.3.js"></script>
<body>
<div id="bgpage" class="container" style="height: 100%"></div>
<script>

    $( function () {
        var pstyle = 'border: 1px solid #dfdfdf; padding: 5px;';
        var $bgp = $('#bgpage');
        $bgp.w2layout({
            name: 'bgpage',
            panels: [
                { type: 'top', size: 120, resizable: true, style: pstyle},
                { type: 'main', style: 'background-color: white;', overflow: 'hidden'},
                { type: 'preview', size: '50%', resizable: true, hidden: true, style: pstyle, content: 'preview' },
                { type: 'right', size: '30%', resizable: true, hidden: true, style: pstyle
                    ,
                    toolbar: {
                        name: "listtoolbar",
                        items: [
                            { type: 'button',  caption: 'Hide List', id: 'item1', // "class":"btn btn-default",
                                onClick: function() {
                                    w2ui['bgpage'].hide('right');
                                }
                            },
                            { type: 'spacer' },
                            { type: 'button',  id: 'item5',  caption: 'Item 5', img: 'icon-save', hint: 'Hint for item 5' }
                        ],
                        onClick: function (event) {
                            this.owner.content('main', event);
                        }
                    }
                }
            ]
        });
//    w2ui['bgpage'].get('right').toolbar.get('item1').addClass("btn btn-default")
        w2ui['bgpage'].load('top','html-frag/top.html');
        w2ui['bgpage'].load('main','html-frag/main.html');

        var currgamerank = -1;


        var showranklist = function (ranktarget) {
            $("#brgmessage").html("Retrieving games by rank ...");
            w2ui['bgpage'].show('right');
            w2ui['bgpage'].load('right', 'html-frag/srchres.html' );
            gi.gamerank(ranktarget, function ($gl) {
                showlist($gl);
                var rankbase = Math.floor((ranktarget - 1) / 100) * 100 + 1;
                $("#searchresults").attr('start', rankbase);

            });
        };

        var showlist = function ($gamelist) {
            var numGames = $gamelist.find('items').attr("total");
            if (!numGames) {
                $("#brgmessage").html("No games found");
                w2ui['bgpage'].hide('right');
                return;
            }
            $("#brgmessage").html(""+numGames +" games found");
            var $gameitem = $("<li/>", {
                html: "<span hidden class='srchres-gameid'/><span class='srchres-gamename'/>",
                "class": "gameitem"
            });

            var $gamelisthtml = $("#searchresults");
            for (var srchlistindex = 0; srchlistindex < numGames; srchlistindex++) {
                var $newGameItem = $gameitem.clone();
                var $item = $gamelist.find('item').eq(srchlistindex);
                $newGameItem.find(".srchres-gameid").html($item.attr("id"));
                var linkcontent = (
                        $item.find('name').attr('value') +
                                " <a>(" + $item.find('yearpublished').attr('value')+")</a>")
                        .replace(/\(\(/g, '(').replace(/\)\)/g,')');
                $newGameItem.find(".srchres-gamename").html(linkcontent);
                $gamelisthtml.append($newGameItem);
            }
            $(document).on('click', '.gameitem', function (evt) {
                var $this = $( this );
                var gameNo = $this.find('.srchres-gameid').text();
                setgameinfo(gameNo);
            });

        };

        var setgameinfo = function (gameNo) {
            gi.gameinfo(gameNo, function(gameinfo) {
                if (gameinfo.valid) {
                    try {
                        $("#gametitle").html(gameinfo.name +'  ('+gameinfo.yearpublished+')');
                        $("#gamepic").attr("src", gameinfo.imageUrl);
                        $("#gamestat-rating").html("Rating: "+parseFloat(gameinfo.rating).toFixed(2));
                        showRating(gameinfo.rating, $("#gamerankparent"));
                        $("#gamestat-raters").html("Number of Raters: "+gameinfo.numraters);
                        $("#gamestat-difficulty").html("Game Difficulty: "+gameinfo.difficulty);
                        $("#gamestat-minage").html("Minimum Age: "+gameinfo.minage);
                        $("#gamestat-rank").html("Boardgame Rank: <a>"+gameinfo.rank+"</a>");
                        $("#gamestat-length").html("Length: : "+gameinfo.playingtime+" minutes");
                        $("#gamestat-description").html(gameinfo.description.replace(/&#10;/g, "<br/>"));
                        currgamerank = gameinfo.rank;
                    } catch (err) {
                        alert("Error " + err);
                    }
                } else {
                    $("#gametitle").html('<pre> Error: '+gameinfo.message+'</pre>');
                    $("#gametitle").css("backgroundColor", "orange");
                }
            });

        };

        var showsearchresults = function () {
            var q = $("#gamesearch").val();
            if (!q || !q.trim()) {
                $("#brgmessage").html("Nothing to search");
                return;
            }
            $("#brgmessage").html("Searching ...");
            w2ui['bgpage'].show('right');
            w2ui['bgpage'].load('right', 'html-frag/srchres.html' );
            gi.gamesearch(q, function ($gl) {showlist($gl);})
        };

        /**
         * Show loading gif when waiting for AJAX results.
         * It turns out that you need to keep a use count because more than one of these fires.
         */
        $(document).bind("ajaxSend", function(){
            var $ld = $("#loading");
            $ld.attr('showcount', parseInt($ld.attr('showcount')) + 1);
            $ld.show();
        }).bind("ajaxComplete", function(){
                    var $ld = $("#loading");
                    var showcount = parseInt($ld.attr('showcount')) - 1;
                    if (showcount <= 0) {
                        $("#loading").hide();
                        $ld.attr('showcount', 0);
                    } else $ld.attr('showcount', showcount);
                });

        $(document).on('keypress', '#gamenum', (function (e){
            if (e.which == 13) {
                var gameNo = $("#gamenum").val();
                setgameinfo(gameNo);
            }
        }));

        $(document).on('keypress', '#gamesearch', (function (e){
            if (e.which == 13) {
                showsearchresults();
            }
        }));

        $(document).on('click', "#getGame, #gametitle", function (evt) {
            var gameNo = $("#gamenum").val();
            setgameinfo(gameNo);
        });
        $(document).on('click', "#searchGame", function x() {showsearchresults()});
        $(document).on(
                'click',
                "#gamestat-rank",
                function (eo) {
                    if (currgamerank > 0)
                        showranklist(currgamerank);
                    return false;
                }
        );

    });

</script>

<script type="application/javascript" src="js/gigetter.js"></script>
<script type="application/javascript" src="js/ratingsUI.js"></script>
<script src="libs/jcanvas.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>

</body>
</html>