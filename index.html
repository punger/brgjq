<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>BBGG 1</title>
    <link rel="stylesheet/less" type="text/css" href="less/style.less" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.5.0/less.min.js" type="text/javascript"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link type="text/css" rel="stylesheet" href="w2ui/w2ui-1.3.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script type="text/javascript" src="w2ui/w2ui-1.3.js"></script>
<body>
<h1 id="greeting">Better Board Game Geek </h1>
<div id="bgpage" style="height: 100%"></div>
<script>

$( function () {
    var pstyle = 'border: 1px solid #dfdfdf; padding: 5px;';
    var $bgp = $('#bgpage');
    $bgp.w2layout({
        name: 'bgpage',
        panels: [
            { type: 'top', size: 50, resizable: true, style: pstyle},
            { type: 'main', style: 'background-color: white;', overflow: 'hidden'},
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: pstyle, content: 'preview' },
            { type: 'right', size: '30%', resizable: true, hidden: true, style: pstyle}
        ]
    });
    w2ui['bgpage'].load('top','html-frag/top.html');
    w2ui['bgpage'].load('main','html-frag/main.html');

    var setgameinfo = function (gameNo) {
        gi.gameinfo(gameNo, function(gameinfo) {
            if (gameinfo.valid) {
                try {
                    $("#myOutput").html(gameinfo.name);
                    $("#gamepic").attr("src", gameinfo.imageUrl);
                    $("#myOutput").addClass("gamename");
                } catch (err) {
                    alert("Error " + err);
                }
            } else {
                $("#myOutput").html('<pre> Error: '+gameinfo.message+'</pre>');
                $("#myOutput").css("backgroundColor", "orange");
            }
        });

    };

    /**
     * Show loading gif when waiting for AJAX results.
     * It turns out that you need to keep a use count because more than one of these fires.
     */
    $(document).bind("ajaxSend", function(){
        var $ld = $("#loading");
        $ld.attr('showcount', parseInt($ld.attr('showcount')) + 1);
        $ld.show();
    }).bind("ajaxComplete", function(){
        var $ld = $("#loading");
        var showcount = parseInt($ld.attr('showcount')) - 1;
        if (showcount <= 0) {
            $("#loading").hide();
            $ld.attr('showcount', 0);
        } else $ld.attr('showcount', showcount);
    });

    $(document).on('click', "#getGame", function (evt) {
        var gameNo = $("#gamenum").val();
        setgameinfo(gameNo);
    });
    $(document).on('click', "#searchGame", function (evt) {
        w2ui['bgpage'].show('right');
        w2ui['bgpage'].load('right', 'html-frag/srchres.html' );
        var q = $("#gamesearch").val();
        gi.gamesearch(q, function ($gamelist) {
            var numGames = $gamelist.find('items').attr("total");
            if (numGames == 0) {
                $("#brgmessage").html("No games found");
                w2ui['bgpage'].hide('right');
                return;
            }
            $("#brgmessage").html(""+numGames +" games found");
            var $gameitem = $("<li/>", {
                html: "<span hidden='true' class='srchres-gameid'/><span class='srchres-gamename'/>",
                "class": "gameitem"
            });

            var $gamelisthtml = $("#searchresults");
            for (var srchlistindex = 0; srchlistindex < numGames; srchlistindex++) {
                var $newGameItem = $gameitem.clone();
                var $item = $gamelist.find('item').eq(srchlistindex);
                $newGameItem.find(".srchres-gameid").html($item.attr("id"));
                $newGameItem.find(".srchres-gamename").html($item.find('name').attr('value'));
                $gamelisthtml.append($newGameItem);
            }
            $(document).on('click', '.gameitem', function (evt) {
                var $this = $( this );
                var gameNo = $this.find('.srchres-gameid').text();
                setgameinfo(gameNo);
            });

        });
    });
});

</script>

<script type="application/javascript" src="js/gigetter.js"></script>
</body>
</html>